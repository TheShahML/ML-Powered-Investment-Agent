name: Monthly (20-Day) Rebalance

on:
  schedule:
    # Run at 9:35 AM ET (14:35 UTC) every trading day
    # The script will check if it's a rebalance day (every 20 trading days)
    - cron: "35 14 * * 1-5"
  workflow_dispatch:
    inputs:
      force_rebalance:
        description: "Force rebalance regardless of day count"
        required: false
        default: "false"
        type: boolean
      dry_run:
        description: "Run without placing actual orders"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: write

env:
  ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
  ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
  ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL }}
  DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
  BROKER_MODE: ${{ secrets.BROKER_MODE }}

jobs:
  check-and-rebalance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check if market is open
        id: market-check
        run: |
          python -c "
          from alpaca_trade_api import REST
          import os
          api = REST(os.environ['ALPACA_API_KEY'], os.environ['ALPACA_SECRET_KEY'], os.environ['ALPACA_BASE_URL'])
          clock = api.get_clock()
          print(f'market_open={str(clock.is_open).lower()}')
          " >> $GITHUB_OUTPUT

      - name: Check if rebalance day (every 20 trading days)
        if: steps.market-check.outputs.market_open == 'true' || github.event_name == 'workflow_dispatch'
        id: rebalance-check
        run: |
          python -c "
          import json
          import os
          from datetime import date

          state_file = 'data/state/rebalance_state.json'

          # Load state
          if os.path.exists(state_file):
              with open(state_file, 'r') as f:
                  state = json.load(f)
          else:
              state = {'days_since_rebalance': 20, 'last_rebalance': None}

          days = state.get('days_since_rebalance', 20)
          force = '${{ inputs.force_rebalance }}' == 'true'

          should_rebalance = days >= 20 or force
          print(f'should_rebalance={str(should_rebalance).lower()}')
          print(f'days_count={days}')
          " >> $GITHUB_OUTPUT

      - name: Execute rebalance via Alpaca
        if: (steps.market-check.outputs.market_open == 'true' && steps.rebalance-check.outputs.should_rebalance == 'true') || (github.event_name == 'workflow_dispatch' && inputs.force_rebalance == 'true')
        run: |
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            python scripts/execute_rebalance.py --dry-run
          else
            python scripts/execute_rebalance.py
          fi

      - name: Increment day counter (no rebalance today)
        if: steps.market-check.outputs.market_open == 'true' && steps.rebalance-check.outputs.should_rebalance == 'false'
        run: python scripts/increment_day_counter.py

      - name: Commit state changes
        if: steps.market-check.outputs.market_open == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/
          git diff --staged --quiet || git commit -m "State update $(date +%Y-%m-%d)"
          git push
