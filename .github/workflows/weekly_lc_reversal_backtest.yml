name: Weekly LC-Reversal Backtest

on:
  schedule:
    - cron: "15 21 * * 0" # Sunday 9:15PM UTC
  workflow_dispatch:
    inputs:
      days:
        description: "Backtest lookback days"
        required: false
        default: "365"
      tx_cost_bps:
        description: "Transaction cost bps per side"
        required: false
        default: "20"
      impact_slippage_mult:
        description: "Simple slippage multiplier on impact_z"
        required: false
        default: "0.0"

concurrency:
  group: investment-bot-lc-reversal-backtest
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  backtest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          tags: investment-bot:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run LC-Reversal backtest
        run: |
          DAYS="${{ github.event.inputs.days || '365' }}"
          TX_COST="${{ github.event.inputs.tx_cost_bps || '20' }}"
          IMPACT_MULT="${{ github.event.inputs.impact_slippage_mult || '0.0' }}"

          docker run --rm \
            -e ALPACA_API_KEY="${{ secrets.ALPACA_API_KEY }}" \
            -e ALPACA_SECRET_KEY="${{ secrets.ALPACA_SECRET_KEY }}" \
            -e ALPACA_BASE_URL="${{ secrets.ALPACA_BASE_URL }}" \
            -e STRATEGY_NAME="lc_reversal" \
            -v "${{ github.workspace }}:/app" \
            -w /app \
            investment-bot:latest \
            python scripts/backtest_lc_reversal.py \
              --days "$DAYS" \
              --tx-cost-bps "$TX_COST" \
              --impact-slippage-mult "$IMPACT_MULT" \
              --output reports/lc_reversal_backtest_${{ github.run_number }}.json

      - name: Send LC-Reversal backtest Discord summary
        if: always()
        run: |
          docker run --rm \
            -e DISCORD_WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -e DISCORD_WEBHOOK_URLS="${{ secrets.DISCORD_WEBHOOK_URLS }}" \
            -v "${{ github.workspace }}:/app" \
            -w /app \
            investment-bot:latest \
            python scripts/notify_lc_backtest.py \
              --input reports/lc_reversal_backtest_${{ github.run_number }}.json

      - name: Upload LC-Reversal backtest artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lc-reversal-backtest-${{ github.run_number }}
          path: reports/lc_reversal_backtest_*.json
          if-no-files-found: error
